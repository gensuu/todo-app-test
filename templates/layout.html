<!DOCTYPE html>
<html lang="ja" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}グリッドTODOアプリ{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {# --- PWA & 習慣カレンダー用 --- #}
    <link rel="manifest" href="{{ url_for('serve_manifest') }}">
    <meta name="theme-color" content="#212529">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192x192.png') }}">
    {# --- 個別ページ用スタイルブロック --- #}
    {% block styles %}{% endblock %}

    <style>
        /* ★ノイズコントロール用スタイル */
        .noise-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* ★スライダーのスタイル調整 */
        #noise-volume-slider {
            width: 80px; /* スライダーの幅を固定 */
            height: 5px; /* スライダーの高さ */
            transition: opacity 0.3s ease-in-out;
        }
         /* ★スライダーつまみのスタイル (オプション) */
        #noise-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px; /* つまみの幅 */
            height: 16px; /* つまみの高さ */
            background: #6a5acd; /* プライマリカラー */
            cursor: pointer;
            border-radius: 50%;
        }
        #noise-volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #6a5acd;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    {% if current_user.is_authenticated %}
    <nav class="navbar navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            
            {# --- ★ サイトタイトル (左端) --- #}
            <a class="navbar-brand" href="{{ url_for('todo_list') }}">Todo Grid</a>

            {# --- ★ブラウンノイズボタンとスライダー (中央・可変幅) --- #}
            <div class="noise-control-group me-auto"> {# me-auto で残りのスペースを埋める #}
                <button id="noise-toggle-btn" class="btn btn-outline-secondary btn-sm border-0 noise-button" title="ブラウンノイズ再生/停止">
                     <i class="bi bi-earbuds"></i>
                </button>
                <input type="range" class="form-range" id="noise-volume-slider"
                       min="-40" max="0" value="-20" step="1"
                       style="display: none;" title="音量調節"> {# widthはstyleタグで指定 #}
            </div>

            {# --- ★ ハンバーガーメニュー (右端) --- #}
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">ようこそ、<br>{{ current_user.username }} さん</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                        {# --- ★ナビゲーション項目整理 (Todoリストを削除) --- #}
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'habit_calendar' %}active{% endif %}" href="{{ url_for('habit_calendar') }}"><i class="bi bi-calendar-heart-fill me-2"></i>習慣カレンダー</a>
                        </li>
                         <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('scratchpad', new='true') }}"><i class="bi bi-pencil-square me-2"></i>今からTodo</a>
                        </li>
                         <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('add_or_edit_task') }}"><i class="bi bi-plus-circle-fill me-2"></i>新しいタスク</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'manage_templates' %}active{% endif %}" href="{{ url_for('manage_templates') }}"><i class="bi bi-journal-album me-2"></i>テンプレート管理</a>
                        </li>
                        <li class="nav-item">
                             <a class="nav-link {% if request.endpoint == 'import_excel' %}active{% endif %}" href="{{ url_for('import_excel') }}"><i class="bi bi-file-earmark-arrow-up me-2"></i>Excelからインポート</a>
                        </li>
                         <li class="nav-item">
                             <form action="{{ url_for('export_to_sheet') }}" method="post" id="export-sheet-form-offcanvas">
                                <button type="submit" class="nav-link btn btn-link text-start w-100">
                                    <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i> スプレッドシートへ書き出し
                                </button>
                             </form>
                        </li>
                         <li><hr class="dropdown-divider"></li>
                        {% if current_user.is_admin %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'admin_panel' %}active{% endif %}" href="{{ url_for('admin_panel') }}"><i class="bi bi-person-badge-fill me-2"></i>管理者用パネル</a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'settings' %}active{% endif %}" href="{{ url_for('settings') }}"><i class="bi bi-gear-fill me-2"></i>設定</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i>ログアウト</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}

    <div class="container-fluid main-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                {% for category, message in messages %}
                     {# ★カテゴリに応じたalertクラスを設定 #}
                    <div class="alert alert-{{ category if category in ['success', 'danger', 'warning', 'info'] else 'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    {# ローディング表示用のHTML #}
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p id="loading-text" class="mt-3 text-light h5">処理中...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {# --- ★Tone.js 読み込み --- #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    {# --- ローディング表示制御 (グローバル関数として定義) --- #}
    <script>
        function showLoadingOverlay(message = '処理中...') {
            const overlay = document.getElementById('loading-overlay');
            const text = document.getElementById('loading-text');
            if (overlay) { if(text) text.textContent = message; overlay.style.display = 'flex'; }
        }
         function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) { overlay.style.display = 'none'; }
         }
         // ページ表示時(BFキャッシュ含む)にローディングを隠す
         window.addEventListener('pageshow', (event) => { hideLoadingOverlay(); });
         // オフキャンバス内のフォーム送信時にもローディング表示
         document.getElementById('export-sheet-form-offcanvas')?.addEventListener('submit', () => showLoadingOverlay('書き出し中...'));
    </script>

     {# --- PWA Service Worker 登録 --- #}
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('serve_sw') }}") // sw.jsのURLを指定
                    .then(reg => console.log('Service Worker registered: ', reg.scope))
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }
    </script>

    {# --- ★ブラウンノイズ再生スクリプト (音量調節対応) --- #}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const noiseBtn = document.getElementById('noise-toggle-btn');
            const noiseIcon = noiseBtn?.querySelector('i');
            const volumeSlider = document.getElementById('noise-volume-slider');
            // ▼▼▼ 修正: localStorageキーを定義 ▼▼▼
            const VOLUME_STORAGE_KEY = 'brownNoiseVolume';
            let noise = null;
            let isPlaying = false;
            let userInteractionDone = false;

            // ▼▼▼ 修正: localStorageから音量を読み込み、スライダーに設定 ▼▼▼
            if (volumeSlider) {
                const savedVolume = localStorage.getItem(VOLUME_STORAGE_KEY);
                if (savedVolume !== null) {
                    volumeSlider.value = savedVolume; // HTMLのvalue属性より優先される
                }
            }
            // ▲▲▲ 修正ここまで ▲▲▲

            async function initializeAudio() {
                if (Tone.context.state === 'running' && noise) {
                    return true;
                }
                if (!userInteractionDone) {
                     console.log('AudioContext requires user interaction first.');
                     return false;
                }
                try {
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                        console.log('AudioContext started!');
                    }
                    if (!noise) {
                        noise = new Tone.Noise("brown").toDestination();
                        // ★音量をスライダーの *現在の* 値（localStorageから復元済み）に設定
                        if(volumeSlider) noise.volume.value = parseFloat(volumeSlider.value); 
                        console.log('Brown noise generator initialized.');
                    }
                    return true;
                } catch (error) {
                    console.error("Failed to initialize Tone.js:", error);
                    alert("音声の初期化に失敗しました。");
                    return false;
                }
            }
            
            document.body.addEventListener('click', () => { userInteractionDone = true; }, { once: true });

            if (noiseBtn && noiseIcon && volumeSlider) { // ★スライダーの存在も確認
                noiseBtn.addEventListener('click', async () => {
                    userInteractionDone = true;
                    const initialized = await initializeAudio();
                    if (!initialized) return;

                    if (isPlaying) {
                        noise.stop();
                        noiseIcon.classList.remove('bi-volume-up-fill');
                        noiseIcon.classList.add('bi-earbuds');
                        noiseBtn.classList.remove('active');
                        volumeSlider.style.display = 'none'; // ★スライダーを隠す
                        isPlaying = false;
                        console.log("Brown noise stopped.");
                    } else {
                        try {
                            if (Tone.context.state !== 'running') { await Tone.start(); }
                            noise.start();
                            noiseIcon.classList.remove('bi-earbuds');
                            noiseIcon.classList.add('bi-volume-up-fill');
                            noiseBtn.classList.add('active');
                            volumeSlider.style.display = 'block'; // ★スライダーを表示
                            isPlaying = true;
                            console.log("Brown noise started.");
                        } catch(error) {
                             console.error("Failed to start noise:", error);
                             alert("ノイズの再生に失敗しました。");
                        }
                    }
                });

                // ★音量スライダーのイベントリスナー
                volumeSlider.addEventListener('input', (e) => {
                    const volumeDb = parseFloat(e.target.value);
                    if (noise) {
                        noise.volume.value = volumeDb;
                    }
                    // ▼▼▼ 修正: 音量をlocalStorageに保存 ▼▼▼
                    localStorage.setItem(VOLUME_STORAGE_KEY, volumeDb.toString());
                    // ▲▲▲ 修正ここまで ▲▲▲
                    console.log("Volume set to:", volumeDb, "dB");
                });
            }
        });
        /*
        * 注意: バックグラウンド再生について
        * ブラウザやOSの制限により、Web Audio API (Tone.jsが使用) の
        * バックグラウンド再生は保証されません。特にiOSでは制限が厳しいです。
        * PWAとしてインストールしても、完全にバックグラウンドで音を
        * 再生し続けることは難しい場合があります。
        * より確実なバックグラウンド再生にはネイティブアプリ開発が必要です。
        */
    </script>

    {# --- 各ページ固有のスクリプト --- #}
    {% block scripts %}
    {% endblock %}

</body>
</html>

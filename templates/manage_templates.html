{% extends "layout.html" %}
{% block title %}テンプレート管理{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-6 mb-5">
            <div class="card">
                <div class="card-header">
                    <h3>新しいテンプレートを作成</h3>
                </div>
                <div class="card-body">
                    <form method="post" id="template-form">
                        <div class="mb-3">
                            <label for="template_title" class="form-label">テンプレート名</label>
                            <input type="text" class="form-control" id="template_title" name="template_title" required>
                        </div>
                        <hr>
                        <h5 class="mb-3">サブタスク</h5>
                        <div id="subtasks-container"></div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <button type="button" id="add-subtask-btn" class="btn btn-secondary"><i class="bi bi-plus-circle"></i> サブタスクを追加</button>
                            <div>
                                <!-- ▼▼▼ 修正点: 戻るボタンのリンクを動的に変更 ▼▼▼ -->
                                <a href="{{ back_url or url_for('todo_list') }}" class="btn btn-outline-secondary">戻る</a>
                                <button type="button" id="save-template-btn" class="btn btn-primary">テンプレートを保存</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <h3>既存のテンプレート</h3>
            <!-- オフライン保存されたテンプレートがここに挿入されます -->
            <div id="offline-templates-container"></div>
            {% for template in templates %}
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>{{ template.title }}</span>
                        <!-- ▼▼▼ 削除ボタンに back_url を引き継ぐ ▼▼▼ -->
                        <form action="{{ url_for('delete_template', template_id=template.id, back_url=back_url or '') }}" method="post" onsubmit="return confirm('本当にこのテンプレートを削除しますか？');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">削除</button>
                        </form>
                    </div>
                    <ul class="list-group list-group-flush">
                        {% for sub in template.subtask_templates %}
                            <li class="list-group-item">{{ sub.content }} ({{ sub.grid_count }}マス)</li>
                        {% else %}
                             <li class="list-group-item">サブタスクがありません。</li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <p id="no-templates-message">保存されているテンプレートはありません。</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- ▼▼▼ オフライン保存機能を追加 ▼▼▼
    async function loadAndDisplayOfflineTemplates() {
        const container = document.getElementById('offline-templates-container');
        const noTemplatesMessage = document.getElementById('no-templates-message');
        
        try {
            const db = await openDB();
            const templates = await new Promise((resolve, reject) => {
                const request = db.transaction(NEW_TEMPLATE_STORE).objectStore(NEW_TEMPLATE_STORE).getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });

            if (templates && templates.length > 0) {
                if (noTemplatesMessage) noTemplatesMessage.style.display = 'none';
                
                // 既存のオフライン表示をクリア
                container.innerHTML = '';

                templates.forEach(template => {
                    const subtasksHtml = template.subtasks.map(sub => 
                        `<li class="list-group-item">${sub.content} (${sub.grid_count}マス)</li>`
                    ).join('');

                    const cardHtml = `
                        <div class="card mb-3 opacity-50">
                            <div class="card-header">
                                ${template.title} <small class="text-warning">(オフライン保存 - 同期待ち)</small>
                            </div>
                            <ul class="list-group list-group-flush">${subtasksHtml}</ul>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', cardHtml);
                });
            }
        } catch (error) {
            console.error("Failed to load offline templates:", error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAndDisplayOfflineTemplates();

        const container = document.getElementById('subtasks-container');
        const addBtn = document.getElementById('add-subtask-btn');
        let subtaskCounter = 0;

        const createSubtaskRow = (task = { content: '', grid_count: 1 }) => {
            subtaskCounter++;
            const row = document.createElement('div');
            row.className = 'row g-2 mb-2 align-items-center subtask-row';
            row.innerHTML = `
                <div class="col"><input type="text" class="form-control" name="sub_content_${subtaskCounter}" placeholder="サブタスクの内容" value="${task.content}" required></div>
                <div class="col-4 col-md-3"><div class="input-group"><input type="number" class="form-control" name="grid_count_${subtaskCounter}" min="1" value="${task.grid_count}" required><span class="input-group-text">マス</span></div></div>
                <div class="col-auto"><button type="button" class="btn btn-sm btn-danger remove-subtask-btn"><i class="bi bi-trash"></i></button></div>
            `;
            container.appendChild(row);
        };
        
        createSubtaskRow();
        addBtn.addEventListener('click', () => createSubtaskRow());
        container.addEventListener('click', (e) => {
            if (e.target.closest('.remove-subtask-btn')) {
                e.target.closest('.subtask-row').remove();
            }
        });

        const saveButton = document.getElementById('save-template-btn');
        const form = document.getElementById('template-form');

        saveButton.addEventListener('click', async () => {
            if (!form.reportValidity()) return;
            showLoadingOverlay('テンプレートを保存中...');

            const templateData = {
                title: document.getElementById('template_title').value.trim(),
                subtasks: Array.from(document.querySelectorAll('.subtask-row')).map(row => ({
                    content: row.querySelector('input[name^="sub_content_"]').value.trim(),
                    grid_count: parseInt(row.querySelector('input[name^="grid_count_"]').value, 10)
                })).filter(s => s.content && s.grid_count > 0)
            };
            
            if (templateData.subtasks.length === 0) {
                alert("少なくとも1つの有効なサブタスクが必要です。");
                hideLoadingOverlay();
                return;
            }

            const isOffline = localStorage.getItem('offlineMode') === 'true' || !navigator.onLine;

            if (isOffline) {
                try {
                    await saveTemplateToOutbox(templateData);
                    hideLoadingOverlay();
                    alert("テンプレートをオフラインで保存しました。オンライン時に同期されます。");
                    // UIに即時反映
                    loadAndDisplayOfflineTemplates();
                    // フォームをリセット
                    document.getElementById('template_title').value = '';
                    container.innerHTML = '';
                    createSubtaskRow();
                } catch(e) {
                    hideLoadingOverlay();
                    alert('オフラインでの保存に失敗しました。');
                }
            } else {
                form.action = "{{ url_for('manage_templates', back_url=back_url or '') }}";
                form.submit();
            }
        });
    });
</script>
{% endblock %}

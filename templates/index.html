<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒªãƒƒãƒ‰TODOã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>ğŸ—“ï¸ Todoãƒªã‚¹ãƒˆ - {{ current_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</h1>
    
    {% set prev_day = current_date - timedelta(days=1) %}
    {% set next_day = current_date + timedelta(days=1) %}
    <p>
        <a href="{{ url_for('todo_list', date_str=prev_day.strftime('%Y-%m-%d')) }}" class="nav-link">&lt; å‰æ—¥ã¸</a>
        | 
        <a href="{{ url_for('todo_list', date_str=date.today().strftime('%Y-%m-%d')) }}" class="nav-link">ä»Šæ—¥ã«æˆ»ã‚‹</a>
        | 
        <a href="{{ url_for('todo_list', date_str=next_day.strftime('%Y-%m-%d')) }}" class="nav-link">ç¿Œæ—¥ã¸ &gt;</a>
    </p>

    <p>
        <a href="{{ url_for('add_or_edit_task') }}" class="nav-link">â• æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </a>
        | 
        <a href="{{ url_for('export_to_sheet', date_str=current_date.strftime('%Y-%m-%d')) }}" class="nav-link">
            âœï¸ å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãå‡ºã—
        </a>
        |
        <a href="{{ url_for('import_excel') }}" class="nav-link">ğŸ“„ Excelã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a> 
    </p>
    <hr>
    
    <h2 id="grid-progress">ğŸŸ¦ ã‚¿ã‚¹ã‚¯é€²æ— æ–¹çœ¼ã‚°ãƒªãƒƒãƒ‰ (å…¨ {{ total_grid_count }} ãƒã‚¹ä¸­ <span id="completed-count-display">{{ completed_grid_count }}</span> ãƒã‚¹å®Œäº†)</h2>

    <div class="grid-container">
        {% for i in range(total_grid_count) %}
            {% if i < completed_grid_count %}
                <div class="grid-cell filled"></div>
            {% else %}
                <div class="grid-cell"></div>
            {% endif %}
        {% endfor %}
    </div>
    <hr>

    <h2>âœ… ã‚¿ã‚¹ã‚¯ä¸€è¦§ (ãƒãƒ¬ãƒƒãƒˆã‚¸ãƒ£ãƒ¼ãƒŠãƒ«é¢¨è¡¨ç¤º)</h2>
    <div class="task-list">
        {% for master_task in master_tasks %}
            <div class="master-task">{{ master_task.title }}</div> 
            <ul>
                {% for subtask in master_task.subtasks %}
                    {% if master_task.due_date == current_date or subtask.is_completed == False %}
                        
                        <li class="sub-task {% if subtask.is_completed %}completed{% endif %}"
                            data-subtask-id="{{ subtask.id }}"
                            data-grid-count="{{ subtask.grid_count }}">
                            
                            <span class="complete-toggle" style="cursor: pointer; text-decoration: none;"
                                  data-is-completed="{{ 'true' if subtask.is_completed else 'false' }}">
                                [{{ 'â˜‘ï¸' if subtask.is_completed else 'â—»ï¸' }}]
                            </span>
                            
                            {{ subtask.content }} ({{ subtask.grid_count }}ãƒã‚¹) 
                            
                            <a href="{{ url_for('add_or_edit_task', master_id=master_task.id) }}" style="margin-left: 10px; font-size: 0.8em; text-decoration: none;">[âœï¸ ç·¨é›†]</a>
                        </li>
                        
                    {% endif %}
                {% endfor %}
            </ul>
        {% else %}
            <p>ã“ã®æ—¥ã«è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã™ã‚‹ã‹ã€åˆ¥ã®æ—¥ä»˜ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
        {% endfor %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleElements = document.querySelectorAll('.complete-toggle');
            const gridCells = document.querySelectorAll('.grid-cell');
            const completedCountDisplay = document.getElementById('completed-count-display');
            
            // --- 1. ã‚¿ã‚¹ã‚¯å®Œäº†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            toggleElements.forEach(toggle => {
                toggle.addEventListener('click', async (event) => {
                    const listItem = toggle.closest('li');
                    const subtaskId = listItem.dataset.subtaskId;
                    
                    // ã‚µãƒ¼ãƒãƒ¼APIã‚’éåŒæœŸã§å‘¼ã³å‡ºã™ (app.pyã® /api/complete_subtask/<id> ã« POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ)
                    const response = await fetch(`/api/complete_subtask/${subtaskId}`, {
                        method: 'POST',
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // 2. DOM (ç”»é¢è¡¨ç¤º) ã®æ›´æ–°
                        
                        // a. ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
                        if (data.is_completed) {
                            listItem.classList.add('completed');
                            toggle.innerHTML = '[â˜‘ï¸]';
                            toggle.dataset.isCompleted = 'true';
                        } else {
                            listItem.classList.remove('completed');
                            toggle.innerHTML = '[â—»ï¸]';
                            toggle.dataset.isCompleted = 'false';
                        }
                        
                        // b. æ–¹çœ¼ã‚°ãƒªãƒƒãƒ‰ã‚’æ›´æ–°
                        updateGrid(data.completed_grid_count);
                        completedCountDisplay.textContent = data.completed_grid_count;
                        
                    } else {
                        alert('ã‚¿ã‚¹ã‚¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼ã®å•é¡Œã‚„ã‚µãƒ¼ãƒãƒ¼å´ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                });
            });

            // --- 2. æ–¹çœ¼ã‚°ãƒªãƒƒãƒ‰ã®æç”»æ›´æ–°é–¢æ•° ---
            function updateGrid(newCompletedCount) {
                gridCells.forEach((cell, index) => {
                    if (index < newCompletedCount) {
                        cell.classList.add('filled');
                    } else {
                        cell.classList.remove('filled');
                    }
                });
            }
        });
    </script>
</body>
</html>
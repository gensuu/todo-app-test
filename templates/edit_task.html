{% extends "layout.html" %}

{% block title %}{% if master_task %}タスクの編集{% else %}新しいタスクの追加{% endif %}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card edit-task-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0 fs-4">{% if master_task %}タスクの編集{% else %}新しいタスクの追加{% endif %}</h2>
                    {# --- ★ テンプレート管理へのリンク (from_url を back_url として渡す) --- #}
                    <a href="{{ url_for('manage_templates', back_url=from_url) }}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-journal-album"></i> テンプレート管理
                    </a>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="flex-grow-1 d-flex align-items-center me-3">
                            <label for="template_selector" class="form-label mb-0 me-2 flex-shrink-0 small text-muted">テンプレート:</label>
                            <select class="form-select form-select-sm" id="template_selector" {% if master_task %}disabled{% endif %}>
                                <option value="">選択して読込...</option>
                                {% for template in templates %}
                                    <option value="{{ template.id }}">{{ template.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="button" id="save-as-template-btn" class="btn btn-outline-secondary btn-sm flex-shrink-0" title="現在の内容をテンプレートとして保存">
                            <i class="bi bi-bookmark-plus"></i> ブックマークへ保存
                        </button>
                    </div>
                     <hr class="mb-4">

                    <form method="post" id="task-form">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="master_title" class="form-label mb-0">タスクタイトル:</label>
                            <div>
                                <input type="checkbox" class="btn-check" role="switch" name="is_urgent" id="is_urgent" autocomplete="off"
                                       {% if master_task and master_task.is_urgent %}checked{% endif %}>
                                <label class="btn btn-outline-warning btn-sm" for="is_urgent">⚠️ 緊急</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="master_title" name="master_title" value="{{ master_task.title if master_task else '' }}" required>
                        </div>

                        <div class="mb-3">
                             <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetails" aria-expanded="false" aria-controls="collapseDetails">
                                 詳細設定 <i class="bi bi-chevron-down small"></i>
                             </button>
                         </div>
                         <div class="collapse" id="collapseDetails">
                             <div class="card card-body bg-dark border-secondary mb-3">
                                 <div class="row g-3 mb-3">
                                     <div class="col-md-6">
                                         <label for="due_date" class="form-label small">期限日 / 開始日</label>
                                         <input type="date" class="form-control form-control-sm" id="due_date" name="due_date" value="{{ (master_task.due_date if master_task else default_date).strftime('%Y-%m-%d') }}">
                                     </div>
                                     <div class="col-md-6">
                                         <label for="recurrence_type" class="form-label small">繰り返し設定</label>
                                         <select class="form-select form-select-sm" id="recurrence_type" name="recurrence_type">
                                             {% set recurrence = master_task.recurrence_type if master_task else 'none' %}
                                             <option value="none" {% if recurrence == 'none' %}selected{% endif %}>繰り返さない</option>
                                             <option value="daily" {% if recurrence == 'daily' %}selected{% endif %}>毎日</option>
                                             <option value="weekly" {% if recurrence == 'weekly' %}selected{% endif %}>毎週</option>
                                         </select>
                                     </div>
                                 </div>
                                 {% set recurrence_type_for_display = master_task.recurrence_type if master_task else 'none' %}
                                 <div class="mb-3" id="recurrence-days-group" style="display: {% if recurrence_type_for_display == 'weekly' %}block{% else %}none{% endif %};">
                                     <label class="form-label small mb-1">繰り返す曜日</label>
                                     <div class="btn-group w-100" role="group" aria-label="曜日選択">
                                         {% set weekdays = [('0', '月'), ('1', '火'), ('2', '水'), ('3', '木'), ('4', '金'), ('5', '土'), ('6', '日')] %}
                                         {# --- ▼▼▼ 修正: `or ''` を追加して None の場合に空文字にする ▼▼▼ --- #}
                                         {% set existing_days = (master_task.recurrence_days or '') if master_task else '' %}
                                         {# --- ▲▲▲ 修正ここまで ▲▲▲ --- #}
                                         {% for day_val, day_name in weekdays %}
                                             <input type="checkbox" class="btn-check" name="recurrence_days" value="{{ day_val }}" id="day_{{ day_val }}" autocomplete="off" {% if day_val in existing_days %}checked{% endif %}>
                                             <label class="btn btn-sm btn-outline-secondary" for="day_{{ day_val }}">{{ day_name }}</label>
                                         {% endfor %}
                                     </div>
                                 </div>
                                  <div class="form-check form-switch">
                                     <input class="form-check-input" type="checkbox" role="switch" name="is_habit" id="is_habit"
                                            {% if master_task and master_task.is_habit %}checked{% endif %}>
                                     <label class="form-check-label small" for="is_habit"><i class="bi bi-calendar-heart-fill text-info"></i> 習慣カレンダーに記録する</label>
                                 </div>
                             </div>
                         </div>

                        <hr>
                        <h5 class="mb-3 d-flex justify-content-between align-items-center">
                            <span>サブタスク</span>
                            <button type="button" id="add-subtask-btn" class="btn btn-sm btn-secondary"><i class="bi bi-plus-circle"></i> 追加</button>
                        </h5>
                        <div id="subtasks-container">
                             {# JSでサブタスク入力欄が追加される #}
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{{ url_for('todo_list', date_str=default_date.strftime('%Y-%m-%d')) }}" class="btn btn-outline-secondary">キャンセル</a>
                            <button type="button" id="save-task-btn" class="btn btn-primary">タスクを保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# --- トースト通知エリア --- #}
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
      <div id="templateSaveToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body"><i class="bi bi-check-circle-fill me-2"></i> テンプレートを保存しました。</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
       <div id="templateErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
         <div class="d-flex">
           <div class="toast-body"><i class="bi bi-exclamation-triangle-fill me-2"></i> <span id="templateErrorText">エラーが発生しました。</span></div>
           <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
         </div>
       </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 要素取得 ---
        const container = document.getElementById('subtasks-container');
        const addBtn = document.getElementById('add-subtask-btn');
        const templateSelector = document.getElementById('template_selector');
        const recurrenceTypeSelect = document.getElementById('recurrence_type');
        const recurrenceDaysGroup = document.getElementById('recurrence-days-group');
        const saveAsTemplateButton = document.getElementById('save-as-template-btn');
        const saveButton = document.getElementById('save-task-btn');
        const form = document.getElementById('task-form');
        const defaultDateValue = "{{ default_date.strftime('%Y-%m-%d') }}";

        // --- トースト要素取得 ---
        const templateSaveToastEl = document.getElementById('templateSaveToast');
        const templateSaveToast = templateSaveToastEl ? new bootstrap.Toast(templateSaveToastEl) : null;
        const templateErrorToastEl = document.getElementById('templateErrorToast');
        const templateErrorToast = templateErrorToastEl ? new bootstrap.Toast(templateErrorToastEl) : null;
        const templateErrorTextEl = document.getElementById('templateErrorText');

        // --- 定数と状態変数 ---
        const maxSubtasks = 20;
        const templatesData = {{ templates_data | tojson | safe }};
        const existingSubtasks = {{ existing_subtasks | tojson | safe }};
        let subtaskCounter = 0;

        // --- 関数定義 ---
        const createSubtaskRow = (task = { content: '', grid_count: 1 }) => {
            if (subtaskCounter >= maxSubtasks) return;
            const newIndex = ++subtaskCounter;
            const row = document.createElement('div');
            row.className = 'row g-2 mb-2 align-items-center subtask-row';
            row.innerHTML = `
                <div class="col"><input type="text" class="form-control form-control-sm" name="sub_content_${newIndex}" placeholder="サブタスクの内容" value="${task.content || ''}" required></div>
                <div class="col-4 col-md-3"><div class="input-group input-group-sm"><input type="number" class="form-control" name="grid_count_${newIndex}" min="1" value="${task.grid_count || 1}" required><span class="input-group-text">マス</span></div></div>
                <div class="col-auto"><button type="button" class="btn btn-sm btn-danger remove-subtask-btn" title="サブタスク削除"><i class="bi bi-trash"></i></button></div>
            `;
            container.appendChild(row);
        };

        const populateSubtasks = (tasks) => {
            container.innerHTML = ''; subtaskCounter = 0;
            if (tasks && tasks.length > 0) tasks.forEach(createSubtaskRow);
            else createSubtaskRow();
        };

        const toggleRecurrenceDays = () => {
            recurrenceDaysGroup.style.display = (recurrenceTypeSelect.value === 'weekly') ? 'block' : 'none';
        };

        const saveTemplate = () => {
            if (!form.reportValidity()) { alert("フォームの内容を確認してください。"); return; }
             const hiddenInput = document.createElement('input');
             hiddenInput.type = 'hidden'; hiddenInput.name = 'save_as_template'; hiddenInput.value = 'true';
             form.appendChild(hiddenInput);
             showLoadingOverlay('テンプレート保存中...');
             const currentUrl = new URL(window.location.href);
             const dateStr = currentUrl.searchParams.get('date_str') || defaultDateValue;
             {% if master_task %} const backUrl = "{{ url_for('add_or_edit_task', master_id=master_task.id) }}?date_str=" + dateStr;
             {% else %} const backUrl = "{{ url_for('add_or_edit_task') }}?date_str=" + dateStr; {% endif %}
             form.action = "{{ url_for('add_or_edit_task', master_id=master_task.id if master_task else None) }}?date_str=" + dateStr + "&back_url=" + encodeURIComponent(backUrl); // back_url をアクションに追加
             form.submit();
         };

        // --- 初期化処理 ---
        populateSubtasks(existingSubtasks);
        toggleRecurrenceDays();

        // --- イベントリスナー設定 ---
        if (templateSelector) templateSelector.addEventListener('change', (e) => {
            const templateId = e.target.value; const masterTitleInput = document.getElementById('master_title');
            if (templateId && templatesData[templateId]) { const t = templatesData[templateId]; masterTitleInput.value = t.title; populateSubtasks(t.subtasks); }
        });
        addBtn.addEventListener('click', () => createSubtaskRow());
        container.addEventListener('click', (e) => { if (e.target.closest('.remove-subtask-btn')) { e.target.closest('.subtask-row').remove(); if (container.children.length === 0) createSubtaskRow(); } });
        recurrenceTypeSelect.addEventListener('change', toggleRecurrenceDays);
        if (saveAsTemplateButton) saveAsTemplateButton.addEventListener('click', saveTemplate);
        saveButton.addEventListener('click', () => {
            if (recurrenceTypeSelect.value === 'weekly') {
                 const checkedDays = form.querySelectorAll('input[name="recurrence_days"]:checked').length;
                 if (checkedDays === 0) { alert("毎週繰り返す場合は曜日を選択。"); recurrenceDaysGroup.scrollIntoView({ behavior: 'smooth', block: 'center' }); recurrenceDaysGroup.classList.add('border', 'border-danger'); setTimeout(() => recurrenceDaysGroup.classList.remove('border', 'border-danger'), 2000); return; }
            }
            if (!form.reportValidity()) return;
            showLoadingOverlay('タスク保存中...');
            const todayJS = new Date(); const yyyy = todayJS.getFullYear(); const mm = String(todayJS.getMonth() + 1).padStart(2, '0'); const dd = String(todayJS.getDate()).padStart(2, '0'); const todayStr = `${yyyy}-${mm}-${dd}`;
            {% if master_task %} if (!navigator.onLine) { alert("編集はオンラインで。"); hideLoadingOverlay(); return; } form.action = "{{ url_for('add_or_edit_task', master_id=master_task.id) }}"; form.submit(); return; {% endif %}
            const isOffline = localStorage.getItem('offlineMode') === 'true' || !navigator.onLine;
            const recurrenceType = document.getElementById('recurrence_type').value; let recurrenceDays = null;
            if (recurrenceType === 'weekly') { recurrenceDays = Array.from(document.querySelectorAll('input[name="recurrence_days"]:checked')).map(cb => cb.value).join(''); }
            const taskData = {
                title: document.getElementById('master_title').value.trim(), due_date: document.getElementById('due_date').value, is_urgent: document.getElementById('is_urgent').checked, is_habit: document.getElementById('is_habit').checked, recurrence_type: recurrenceType, recurrence_days: recurrenceDays,
                subtasks: Array.from(document.querySelectorAll('.subtask-row')).map(row => ({ content: row.querySelector('input[name^="sub_content_"]').value.trim(), grid_count: parseInt(row.querySelector('input[name^="grid_count_"]').value, 10) || 0 })).filter(s => s.content && s.grid_count > 0)
            };
            if (taskData.subtasks.length === 0) { alert("有効なサブタスクが最低1つ必要。"); hideLoadingOverlay(); return; }
            if (isOffline) {
                saveNewTaskToOutbox(taskData).then(() => { const redirectDate = (taskData.recurrence_type !== 'none') ? todayStr : taskData.due_date; window.location.href = `/todo/${redirectDate}`; }).catch(error => { console.error("Offline save error:", error); alert("オフライン保存失敗。"); hideLoadingOverlay(); });
            } else { form.action = "{{ url_for('add_or_edit_task') }}"; form.submit(); }
        });
    });
</script>
{% endblock %}


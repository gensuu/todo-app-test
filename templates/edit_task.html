{% extends "layout.html" %}

{% block title %}{% if master_task %}タスクの編集{% else %}新しいタスクの追加{% endif %}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card edit-task-card">
                <div class="card-header">
                    <h2 class="mb-0">{% if master_task %}タスクの編集{% else %}新しいタスクの追加{% endif %}</h2>
                </div>
                <div class="card-body">
                    {# --- ★テンプレートセクション --- #}
                    {% if not master_task %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label for="template_selector" class="form-label mb-0 me-2 flex-shrink-0 small text-muted">テンプレート:</label> {# ラベル調整 #}
                        <div class="flex-grow-1 me-2">
                             <select class="form-select form-select-sm" id="template_selector"> {# Selectをsmサイズに #}
                                <option value="">選択して読込...</option>
                                {% for template in templates %}
                                    <option value="{{ template.id }}">{{ template.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                         {# ★テンプレート保存ボタン (API呼び出しに変更) #}
                         <button type="button" id="save-as-template-btn" class="btn btn-outline-secondary btn-sm rounded-circle" title="現在の内容をテンプレートとして保存">
                             <i class="bi bi-bookmark-plus"></i>
                         </button>
                    </div>
                     <hr class="mb-4">
                    {% endif %}

                    <form method="post" id="task-form">
                        {# --- ★基本設定セクション (タイトルと緊急スイッチ) --- #}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label for="master_title" class="form-label mb-0 me-2 flex-shrink-0">タスクタイトル:</label>
                            <input type="text" class="form-control me-2" id="master_title" name="master_title" value="{{ master_task.title if master_task else '' }}" required>
                             {# ★緊急タスクスイッチ #}
                            <div class="form-check form-switch flex-shrink-0" title="緊急タスクとしてマーク">
                                <input class="form-check-input" type="checkbox" role="switch" name="is_urgent" id="is_urgent" {% if master_task and master_task.is_urgent %}checked{% endif %}>
                                <label class="form-check-label small visually-hidden" for="is_urgent">緊急</label> {# ラベルは非表示に #}
                                <i class="bi bi-exclamation-triangle-fill text-danger"></i> {# アイコンで示す #}
                            </div>
                        </div>

                        {# --- ★詳細設定 (折りたたみ) --- #}
                        <div class="mb-3">
                             <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetails" aria-expanded="false" aria-controls="collapseDetails">
                                 詳細設定 <i class="bi bi-chevron-down small"></i>
                             </button>
                         </div>
                         <div class="collapse" id="collapseDetails">
                             <div class="card card-body bg-dark border-secondary mb-3"> {# 背景色変更 #}
                                 {# 期限日/開始日 と 繰り返し種別 #}
                                 <div class="row g-3 mb-3">
                                     <div class="col-md-6">
                                         <label for="due_date" class="form-label small">期限日 / 開始日</label>
                                         {# ★ default_date を確実に反映 #}
                                         <input type="date" class="form-control form-control-sm" id="due_date" name="due_date" value="{{ (master_task.due_date if master_task else default_date).strftime('%Y-%m-%d') }}">
                                     </div>
                                     <div class="col-md-6">
                                         <label for="recurrence_type" class="form-label small">繰り返し設定</label>
                                         <select class="form-select form-select-sm" id="recurrence_type" name="recurrence_type">
                                             <option value="none" {% if not master_task or master_task.recurrence_type == 'none' %}selected{% endif %}>繰り返さない</option>
                                             <option value="daily" {% if master_task and master_task.recurrence_type == 'daily' %}selected{% endif %}>毎日</option>
                                             <option value="weekly" {% if master_task and master_task.recurrence_type == 'weekly' %}selected{% endif %}>毎週</option>
                                         </select>
                                     </div>
                                 </div>
                                 {# 繰り返す曜日 (毎週選択時のみ表示) #}
                                 <div class="mb-3" id="recurrence-days-group" style="display: {% if master_task and master_task.recurrence_type == 'weekly' %}block{% else %}none{% endif %};"> {# 初期表示制御 #}
                                     <label class="form-label small mb-1">繰り返す曜日</label>
                                     <div class="btn-group w-100" role="group" aria-label="曜日選択">
                                         {% set weekdays = [('0', '月'), ('1', '火'), ('2', '水'), ('3', '木'), ('4', '金'), ('5', '土'), ('6', '日')] %}
                                         {% set existing_days = master_task.recurrence_days if master_task and master_task.recurrence_days else '' %}
                                         {% for day_val, day_name in weekdays %}
                                             <input type="checkbox" class="btn-check" name="recurrence_days" value="{{ day_val }}" id="day_{{ day_val }}" autocomplete="off" {% if day_val in existing_days %}checked{% endif %}>
                                             <label class="btn btn-sm btn-outline-secondary" for="day_{{ day_val }}">{{ day_name }}</label>
                                         {% endfor %}
                                     </div>
                                 </div>
                                  {# 習慣カレンダー記録スイッチ #}
                                  <div class="form-check form-switch">
                                     <input class="form-check-input" type="checkbox" role="switch" name="is_habit" id="is_habit" {% if master_task and master_task.is_habit %}checked{% endif %}>
                                     <label class="form-check-label small" for="is_habit"><i class="bi bi-calendar-heart-fill text-info"></i> 習慣カレンダーに記録する</label>
                                 </div>
                             </div>
                         </div>
                         {# --- ▲▲▲ 詳細設定ここまで ▲▲▲ --- #}

                        <hr>
                        <h5 class="mb-3 d-flex justify-content-between align-items-center">
                            <span>サブタスク</span>
                            <button type="button" id="add-subtask-btn" class="btn btn-sm btn-secondary"><i class="bi bi-plus-circle"></i> 追加</button> {# ボタンを右上に移動 #}
                        </h5>
                        <div id="subtasks-container">
                             {# JSでサブタスク入力欄が追加される #}
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4"> {# ボタンを右寄せに #}
                            {# ★キャンセルボタンの戻り先修正 #}
                            <a href="{{ url_for('todo_list', date_str=default_date.strftime('%Y-%m-%d')) }}" class="btn btn-outline-secondary">キャンセル</a>
                            <button type="button" id="save-task-btn" class="btn btn-primary">タスクを保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# --- トースト通知エリア --- #}
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"> {# z-index追加 #}
      {# テンプレート保存成功トースト #}
      <div id="templateSaveToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-check-circle-fill me-2"></i> テンプレートを保存しました。
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
       {# テンプレート保存失敗トースト #}
       <div id="templateErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
         <div class="d-flex">
           <div class="toast-body">
             <i class="bi bi-exclamation-triangle-fill me-2"></i> <span id="templateErrorText">エラーが発生しました。</span>
           </div>
           <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
         </div>
       </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 要素取得 ---
        const container = document.getElementById('subtasks-container');
        const addBtn = document.getElementById('add-subtask-btn');
        const templateSelector = document.getElementById('template_selector');
        const recurrenceTypeSelect = document.getElementById('recurrence_type');
        const recurrenceDaysGroup = document.getElementById('recurrence-days-group');
        const saveAsTemplateButton = document.getElementById('save-as-template-btn');
        const saveButton = document.getElementById('save-task-btn');
        const form = document.getElementById('task-form');
        const defaultDateValue = "{{ default_date.strftime('%Y-%m-%d') }}"; // ★ デフォルト日付を取得

        // --- トースト要素取得 ---
        const templateSaveToastEl = document.getElementById('templateSaveToast');
        const templateSaveToast = templateSaveToastEl ? new bootstrap.Toast(templateSaveToastEl) : null;
        const templateErrorToastEl = document.getElementById('templateErrorToast');
        const templateErrorToast = templateErrorToastEl ? new bootstrap.Toast(templateErrorToastEl) : null;
        const templateErrorTextEl = document.getElementById('templateErrorText');

        // --- 定数と状態変数 ---
        const maxSubtasks = 20;
        const templatesData = {{ templates_data | tojson | safe }};
        const existingSubtasks = {{ existing_subtasks | tojson | safe }};
        let subtaskCounter = 0;

        // --- 関数定義 ---
        const createSubtaskRow = (task = { content: '', grid_count: 1 }) => {
            if (subtaskCounter >= maxSubtasks) return;
            const newIndex = ++subtaskCounter;
            const row = document.createElement('div');
            row.className = 'row g-2 mb-2 align-items-center subtask-row';
            row.innerHTML = `
                <div class="col"><input type="text" class="form-control form-control-sm" name="sub_content_${newIndex}" placeholder="サブタスクの内容" value="${task.content || ''}" required></div>
                <div class="col-4 col-md-3"><div class="input-group input-group-sm"><input type="number" class="form-control" name="grid_count_${newIndex}" min="1" value="${task.grid_count || 1}" required><span class="input-group-text">マス</span></div></div>
                <div class="col-auto"><button type="button" class="btn btn-sm btn-danger remove-subtask-btn" title="サブタスク削除"><i class="bi bi-trash"></i></button></div>
            `; // valueがnullの場合を考慮
            container.appendChild(row);
        };

        const populateSubtasks = (tasks) => {
            container.innerHTML = '';
            subtaskCounter = 0;
            if (tasks && tasks.length > 0) {
                tasks.forEach(createSubtaskRow);
            } else {
                createSubtaskRow(); // 最低1行は表示
            }
        };

        const toggleRecurrenceDays = () => {
            recurrenceDaysGroup.style.display = (recurrenceTypeSelect.value === 'weekly') ? 'block' : 'none';
        };

        // ★テンプレート保存API呼び出し関数
        const saveTemplate = async () => {
             const title = document.getElementById('master_title').value.trim();
             if (!title) { alert("テンプレート保存にはタイトルが必要です。"); return; }
             const subtasks = Array.from(document.querySelectorAll('.subtask-row')).map(row => ({
                 content: row.querySelector('input[name^="sub_content_"]').value.trim(),
                 grid_count: parseInt(row.querySelector('input[name^="grid_count_"]').value, 10) || 0
             })).filter(s => s.content && s.grid_count > 0);
             if (subtasks.length === 0) { alert("有効なサブタスクが最低1つ必要です。"); return; }

             showLoadingOverlay('テンプレート保存中...');
             try {
                 const response = await fetch("{{ url_for('save_template_api') }}", {
                     method: 'POST', headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ title: title, subtasks: subtasks })
                 });
                 const data = await response.json();
                 hideLoadingOverlay();
                 if (data.success) { if(templateSaveToast) templateSaveToast.show(); }
                 else {
                      if(templateErrorTextEl) templateErrorTextEl.textContent = data.error || '不明なエラー';
                      if(templateErrorToast) templateErrorToast.show();
                 }
             } catch (error) {
                 hideLoadingOverlay(); console.error("Template save error:", error);
                  if(templateErrorTextEl) templateErrorTextEl.textContent = '通信エラーが発生しました。';
                  if(templateErrorToast) templateErrorToast.show();
             }
         };

        // --- 初期化処理 ---
        populateSubtasks(existingSubtasks); // サブタスク初期表示
        toggleRecurrenceDays(); // 繰り返し曜日表示初期化

        // --- イベントリスナー設定 ---
        if (templateSelector) {
            templateSelector.addEventListener('change', (e) => {
                const templateId = e.target.value;
                const masterTitleInput = document.getElementById('master_title');
                if (templateId && templatesData[templateId]) {
                    const t = templatesData[templateId];
                    masterTitleInput.value = t.title;
                    populateSubtasks(t.subtasks);
                }
                // 「選択して読込...」に戻したらフォームをクリアするかは任意
                // else { masterTitleInput.value = ''; populateSubtasks([]); }
            });
        }

        addBtn.addEventListener('click', () => createSubtaskRow());
        container.addEventListener('click', (e) => {
            if (e.target.closest('.remove-subtask-btn')) {
                e.target.closest('.subtask-row').remove();
                if (container.children.length === 0) createSubtaskRow(); // 0になったら追加
            }
        });
        recurrenceTypeSelect.addEventListener('change', toggleRecurrenceDays);
        if (saveAsTemplateButton) saveAsTemplateButton.addEventListener('click', saveTemplate);

        saveButton.addEventListener('click', () => {
            // 曜日選択バリデーション
            if (recurrenceTypeSelect.value === 'weekly') {
                 const checkedDays = form.querySelectorAll('input[name="recurrence_days"]:checked').length;
                 if (checkedDays === 0) {
                     alert("毎週繰り返す場合は曜日を選択してください。");
                     recurrenceDaysGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     recurrenceDaysGroup.classList.add('border', 'border-danger');
                     setTimeout(() => recurrenceDaysGroup.classList.remove('border', 'border-danger'), 2000);
                     return;
                 }
            }
            if (!form.reportValidity()) return; // HTML5標準バリデーション
            showLoadingOverlay('タスク保存中...');

            // 編集モードは常にオンラインPOST (変更なし)
            {% if master_task %}
                if (!navigator.onLine) { alert("編集はオンラインである必要があります。"); hideLoadingOverlay(); return; }
                form.action = "{{ url_for('add_or_edit_task', master_id=master_task.id) }}";
                form.submit(); return;
            {% endif %}

            // --- 新規作成: オフライン対応ロジック (変更なし) ---
            const isOffline = localStorage.getItem('offlineMode') === 'true' || !navigator.onLine;
            const recurrenceType = document.getElementById('recurrence_type').value;
            let recurrenceDays = null;
            if (recurrenceType === 'weekly') { recurrenceDays = Array.from(document.querySelectorAll('input[name="recurrence_days"]:checked')).map(cb => cb.value).join(''); }
            const taskData = {
                title: document.getElementById('master_title').value.trim(),
                due_date: document.getElementById('due_date').value,
                is_urgent: document.getElementById('is_urgent').checked,
                is_habit: document.getElementById('is_habit').checked,
                recurrence_type: recurrenceType,
                recurrence_days: recurrenceDays,
                subtasks: Array.from(document.querySelectorAll('.subtask-row')).map(row => ({
                    content: row.querySelector('input[name^="sub_content_"]').value.trim(),
                    grid_count: parseInt(row.querySelector('input[name^="grid_count_"]').value, 10) || 0
                })).filter(s => s.content && s.grid_count > 0)
            };
            if (taskData.subtasks.length === 0) { alert("有効なサブタスクが最低1つ必要です。"); hideLoadingOverlay(); return; }
            if (isOffline) {
                saveNewTaskToOutbox(taskData)
                    .then(() => {
                        const redirectDate = (taskData.recurrence_type !== 'none') ? "{{ get_jst_today().strftime('%Y-%m-%d') }}" : taskData.due_date;
                        window.location.href = `/todo/${redirectDate}`;
                    })
                    .catch(error => { console.error("Offline save error:", error); alert("オフライン保存失敗。"); hideLoadingOverlay(); });
            } else { form.action = "{{ url_for('add_or_edit_task') }}"; form.submit(); }
        });
    });
</script>
{% endblock %}

